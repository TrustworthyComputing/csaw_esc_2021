#include "hal.h"
#include <stdint.h>
#include <stdlib.h>
#include <stdio.h>
#include "../simpleserial/simpleserial.h"

// DUMMY VAL
uint8_t key[] = {1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16};

static const uint8_t sb_1[256] = {
  65, 70, 5, 83, 184, 146, 151, 217, 45, 134, 38, 214, 130, 128, 66, 249,
  172, 34, 197, 237, 200, 249, 103, 215, 127, 38, 19, 166, 21, 175, 77, 202,
  234, 109, 5, 33, 41, 28, 160, 9, 80, 27, 88, 64, 122, 157, 85, 244,
  105, 61, 216, 85, 125, 164, 14, 120, 243, 76, 177, 77, 46, 254, 141, 83,
  188, 144, 67, 17, 49, 103, 113, 39, 185, 50, 137, 76, 202, 89, 206, 176,
  169, 137, 145, 196, 37, 71, 98, 97, 9, 88, 242, 171, 158, 209, 236, 211,
  195, 204, 193, 13, 65, 22, 114, 160, 95, 3, 179, 28, 123, 224, 124, 177,
  89, 142, 12, 150, 28, 180, 8, 48, 218, 92, 60, 223, 177, 231, 196, 251,
  218, 147, 98, 77, 105, 135, 168, 110, 78, 220, 169, 113, 224, 82, 178, 44,
  91, 75, 114, 88, 195, 104, 215, 4, 55, 246, 224, 52, 152, 102, 28, 214,
  171, 31, 159, 104, 196, 78, 161, 255, 174, 98, 179, 90, 16, 42, 166, 21,
  134, 63, 76, 22, 120, 19, 1, 12, 109, 252, 21, 170, 131, 121, 16, 38,
  45, 80, 42, 206, 205, 229, 105, 175, 153, 49, 33, 157, 169, 168, 110, 58,
  83, 133, 49, 74, 159, 147, 254, 174, 5, 2, 112, 66, 157, 247, 145, 115,
  3, 47, 173, 223, 158, 62, 46, 142, 184, 21, 117, 152, 143, 248, 182, 100,
  64, 173, 126, 199, 129, 1, 81, 27, 142, 5, 152, 80, 214, 127, 139, 146 };

  static const uint8_t sb_2[256] = {
  45, 227, 139, 61, 153, 80, 53, 182, 106, 69, 24, 130, 47, 249, 223, 37,
  146, 37, 53, 79, 10, 95, 159, 148, 208, 126, 112, 204, 57, 198, 20, 48,
  139, 119, 59, 182, 9, 54, 153, 39, 8, 231, 131, 188, 46, 198, 32, 106,
  125, 137, 126, 154, 115, 233, 190, 211, 81, 25, 216, 215, 9, 116, 20, 12,
  191, 204, 66, 69, 203, 253, 124, 117, 100, 104, 16, 35, 245, 251, 101, 63,
  177, 225, 182, 219, 137, 134, 92, 117, 208, 23, 84, 249, 197, 26, 248, 158,
  92, 93, 38, 24, 139, 102, 12, 44, 124, 66, 80, 239, 170, 143, 34, 186,
  35, 151, 31, 96, 33, 234, 91, 43, 170, 190, 173, 16, 18, 177, 213, 49,
  37, 126, 27, 211, 215, 227, 226, 12, 54, 35, 154, 71, 7, 55, 112, 224,
  86, 26, 18, 82, 108, 99, 215, 104, 106, 119, 156, 196, 113, 153, 118, 177,
  146, 156, 119, 16, 75, 186, 141, 43, 40, 92, 125, 152, 201, 213, 210, 109,
  73, 120, 9, 50, 239, 210, 183, 242, 46, 69, 153, 10, 154, 222, 203, 38,
  107, 219, 245, 148, 77, 126, 32, 127, 201, 9, 209, 18, 1, 33, 83, 190,
  173, 157, 3, 151, 247, 190, 142, 17, 179, 207, 102, 181, 82, 186, 216, 255,
  234, 89, 199, 222, 97, 122, 159, 84, 235, 213, 94, 223, 174, 252, 101, 134,
  241, 43, 22, 47, 26, 115, 81, 254, 19, 7, 213, 189, 5, 175, 49, 110 };

uint8_t encrypt(uint8_t* data, uint8_t dlen) {
  trigger_high();
  for (int i = 0; i < 16; i++) {
    for (int j = 0; j < 8; j++) {
      uint8_t key_bit = (key[i] >> j) & 1;
      if (key_bit) {
        data[i] = (sb_1[data[i]] - sb_2[data[i]]);
        data[i] ^= 0xFF;
        data[i] += data[sb_2[data[i]]%16];
      }
      else {
        data[i] *= data[i];
        data[i] *= sb_2[data[i]];
        data[i] -= data[sb_1[data[i]]%16];
      }
    }
  }
  trigger_low();
  simpleserial_put('r', 16, data);
  return 0x00;
}

int main(void) {

  // GOAL: Can you find the key?
  platform_init();
  init_uart();
  trigger_setup();
  simpleserial_init();

  simpleserial_addcmd('e', 16, encrypt);

  while(1) simpleserial_get();

  return 0;
}
